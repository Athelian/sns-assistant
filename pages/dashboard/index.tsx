import { type NextPage } from 'next'
import Head from 'next/head'

import Footer from '@/components/footer'
import Header from '@/components/header'

const Dashboard: NextPage = () => {
  const handleClick = () => {
    // @see https://developers.facebook.com/docs/sharing/reference/share-dialog/
    FB.ui({
      method: 'share',
      href: 'https://developers.facebook.com/docs/',
    })
  }

  return (
    <>
      <Head>
        <title>Snai</title>
        <meta content="width=device-width, initial-scale=1" name="viewport" />
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.png" />
      </Head>
      <main
        className={
          'min-h-screen min-w-[800px] text-[x-large] flex flex-col justify-between'
        }
      >
        <Header />
        <button
          onClick={() => {
            FB.login(function (response) {
              if (response.authResponse) {
                console.log('Welcome!  Fetching your information.... ')
                FB.api('/me', function (response) {
                  console.log('Good to see you, ' + response.name + '.')
                })
              } else {
                console.log('User cancelled login or did not fully authorize.')
              }
            })
          }}
        >
          fb login
        </button>
        <button
          onClick={async () => {
            let allPosts: { id: string; message?: string }[] = []
            let next: string | void | null = ''

            next = await new Promise<string>((resolve, reject) =>
              FB.api<'posts{message}'>(
                '/me',
                { fields: ['posts{message}'] },
                (res) => {
                  if (!res.posts) {
                    return reject(res)
                  }
                  allPosts = allPosts.concat(res.posts.data)
                  resolve(res.posts.paging.next)
                }
              )
            ).catch((error) => {
              console.error(error)
            })

            while (typeof next === 'string') {
              next = await new Promise<string | null>((resolve, reject) => {
                if (typeof next === 'string') {
                  FB.api<{
                    data: { id: string; message?: string }[]
                    paging: { next: string; previous: string }
                  }>(next, (res) => {
                    if (!res.data) {
                      return reject(res)
                    }
                    if (!res.data.length) {
                      return resolve(null)
                    }
                    allPosts = allPosts.concat(res.data)
                    resolve(res.paging.next)
                  })
                }
              }).catch((error) => {
                console.error(error)
              })
              console.log(allPosts)
            }
          }}
        >
          get user data
        </button>
        <div>
          <button onClick={handleClick}>シェアする</button>
        </div>
        <Footer />
      </main>
    </>
  )
}

export default Dashboard
